package modelo.ImplDAO;

import java.sql.ResultSet;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collection;

import mapper.AlumnoMapper;
import modelo.AbstractDAO.AlumnoDAO;
import modelo.Entity.Alumno;
import modelo.acceso.AccessJdbc;

public class AlumnoDAOJDBC implements AlumnoDAO {
	private final DAOFactoryJDBC daoFactoryJDBC;

	public AlumnoDAOJDBC(DAOFactoryJDBC daoFactoryJDBC) {
		super();
		this.daoFactoryJDBC = daoFactoryJDBC;
	}

	/// rellenamos create, inserta nuevo alumno
	/// DateTimmeFormatter convierte Localdate a String en formato sql
	/// usa executeUpdate de accessJdbc para la operación insert
	@Override
	public void create(Alumno entidad) {
		// TODO Auto-generated method stub
		DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
		String fechaFormateada = entidad.getFechaNacimiento().format(formatter);
		

		String query = "INSERT INTO alumnos (Matricula, Nombre, Apellidos, Sexo, FechaNacimiento) VALUES ("
			+ "'" + entidad.getMatricula() + "', "
			+ "'" + entidad.getNombre() + "', "
			+ "'" + entidad.getApellidos() + "', "
			+ "'" + entidad.getSexo() + "', "
			+ "'" + fechaFormateada + "')";
		
	}
	
	/////////////////////////////////////////////////////////////////////////
	/// Problemon
	///
	 /**
	  * Guay porque funciona. mal porque rompemos DRY al tener que implementar, casi lo mismo,
	  * en todos los DAOS solucion en DRY DAO ALumno
	*/

	@Override
	public Collection<Alumno> findAll() {
		return daoFactoryJDBC.findAllGeneric("SELECT * FROM alumnos", new AlumnoMapper());
	}

	@Override
	public Alumno findById(String id) {
		// TODO Auto-generated method stub
		///añadimos findById, busca alumno específico por su matrícula
		/// utiliza el método genérico findAllGeneric de la factory para evitar duplicar código
		/// retorna el primer elemnto de la colección o null si no hay resultados
		String query = "select * from alumnos where Matricula like '" + id + "'";
		Collection<Alumno> resultado = daoFactoryJDBC.findAllGeneric(query, new AlumnoMapper());
		
		// si la selección tiene elementos, retornar el primero, si no null
		if (resultado != null && !resultado.isEmpty()) {
			return resultado.iterator().next();
		}
		return null;
	}

}
